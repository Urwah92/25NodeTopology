name: century

topology:
  nodes:
    # ---------- L2 Switches ----------
    switch_a:
      kind: ovs-bridge
    switch_b:
      kind: ovs-bridge

    # ---------- Router between the two OVS bridges ----------
    rtr:
      kind: linux
      image: frrouting/frr:v7.5.1
      binds:
        - rtr/daemons:/etc/frr/daemons
        - rtr/frr.conf:/etc/frr/frr.conf

    serf1:
      kind: linux
      image: abdullahmuzlim279/k3s-serf-node:warmcache-test
      env:
        CLAB_LINUX_PRIVILEGED: "true"
      binds:
        - /sys/fs/cgroup:/sys/fs/cgroup:rw
        - /lib/modules:/lib/modules:ro
        - /dev:/dev
      cmd: >
          bash -c '
            set -e
            echo "[INIT] Preparing system..."
            ulimit -n 65536
            sysctl -w fs.inotify.max_user_instances=4096
            sysctl -w fs.inotify.max_user_watches=524288
            sysctl -w fs.file-max=2097152

            # Disable PSI reporting to avoid issues with cgroup enforcement
            echo 0 > /sys/fs/cgroup/cpu.pressure || true
            echo 0 > /sys/fs/cgroup/memory.pressure || true

            # Wait for eth1 to appear
            echo "[NET] Waiting for eth1 to be created..."
            until ip link show eth1 >/dev/null 2>&1; do
                sleep 1
            done
            echo "[NET] eth1 detected."

            # Set up network
            ip link set eth1 up
            #ip addr add 10.0.1.11/24 brd 10.0.1.255 dev eth1
            ip link set eth1 mtu 1400

            # Small randomized delay
            sleep $((RANDOM % 10 + 5))

            # Start K3s (with cgroup enforcement disabled)
            echo "[INIT] Launching optimized K3s server with relaxed cgroups..."
            k3s server \
              --node-name serf1 \
              --disable traefik \
              --disable servicelb \
              --disable local-storage \
              --disable metrics-server \
              --disable-cloud-controller \
              --disable-network-policy \
              --disable-helm-controller \
              --snapshotter native \
              --tls-san 10.0.1.11 \
              --kubelet-arg=cgroup-root=/ \
              --kubelet-arg=cgroups-per-qos=false \
              --kubelet-arg=enforce-node-allocatable= \
              --v=0 &

            sleep 20
            chmod 666 /etc/rancher/k3s/k3s.yaml
            export KUBECONFIG=/etc/rancher/k3s/k3s.yaml

            echo "[INIT] Waiting for containerd to be ready..."
            until /usr/local/bin/k3s ctr version >/dev/null 2>&1; do
                echo "  containerd not yet ready, retrying..."
                sleep 3
            done
            echo "Containerd is ready."

            echo "[INIT] Importing cached images..."
            for f in /opt/k3s-images/*.tar; do
                echo "Loading $f ..."
                /usr/local/bin/k3s ctr images import "$f" || true
            done
            
            k3s kubectl apply -f /tmp/qos-controller-daemonset.yaml
            k3s kubectl apply -f /tmp/service-account.yaml
            k3s kubectl apply -f /tmp/cluster-role.yaml
            k3s kubectl apply -f /tmp/cluster-role-binding.yaml
            k3s kubectl apply -f /tmp/deployment-scheduler.yaml
            k3s kubectl apply -f /tmp/ram_price.yaml
            k3s kubectl apply -f /tmp/storage_price.yaml
            k3s kubectl apply -f /tmp/vcpu_price.yaml
            k3s kubectl apply -f /tmp/vgpu_price.yaml   

            mkdir -p ~/.kube
            cp /etc/rancher/k3s/k3s.yaml ~/.kube/config
            chown $(whoami):$(whoami) ~/.kube/config
            chmod 600 ~/.kube/config

            echo "[READY] K3s cluster is up and running on $(hostname)."
            
            while true; do
                sync
                echo 3 > /proc/sys/vm/drop_caches
                sleep 100000
            done &

            sleep infinity
          '

    serf2:
      kind: linux
      image: abdullahmuzlim279/k3s-serf-node:warmcache-test
      env:
        CLAB_LINUX_PRIVILEGED: "true"
      binds:
        - /sys/fs/cgroup:/sys/fs/cgroup:rw
        - /lib/modules:/lib/modules:ro
        - /dev:/dev
      cmd: >
          bash -c '
            set -e
            echo "[INIT] Preparing system..."
            ulimit -n 65536
            sysctl -w fs.inotify.max_user_instances=4096
            sysctl -w fs.inotify.max_user_watches=524288
            sysctl -w fs.file-max=2097152

            echo 0 > /sys/fs/cgroup/cpu.pressure || true
            echo 0 > /sys/fs/cgroup/memory.pressure || true

            echo "[NET] Waiting for eth1 to be created..."
            until ip link show eth1 >/dev/null 2>&1; do
                sleep 1
            done
            echo "[NET] eth1 detected."

            ip link set eth1 up
            #ip addr add 10.0.1.12/24 brd 10.0.1.255 dev eth1
            ip link set eth1 mtu 1400

            sleep $((RANDOM % 10 + 5))

            echo "[INIT] Launching optimized K3s server with relaxed cgroups..."
            k3s server \
              --node-name serf2 \
              --disable traefik \
              --disable servicelb \
              --disable local-storage \
              --disable metrics-server \
              --disable-cloud-controller \
              --disable-network-policy \
              --disable-helm-controller \
              --snapshotter native \
              --tls-san 10.0.1.12 \
              --kubelet-arg=cgroup-root=/ \
              --kubelet-arg=cgroups-per-qos=false \
              --kubelet-arg=enforce-node-allocatable= \
              --v=0 &

            sleep 20
            chmod 666 /etc/rancher/k3s/k3s.yaml
            export KUBECONFIG=/etc/rancher/k3s/k3s.yaml

            echo "[INIT] Waiting for containerd to be ready..."
            until /usr/local/bin/k3s ctr version >/dev/null 2>&1; do
                echo "  containerd not yet ready, retrying..."
                sleep 3
            done
            echo "Containerd is ready."

            echo "[INIT] Importing cached images..."
            for f in /opt/k3s-images/*.tar; do
                echo "Loading $f ..."
                /usr/local/bin/k3s ctr images import "$f" || true
            done

            k3s kubectl apply -f /tmp/qos-controller-daemonset.yaml
            k3s kubectl apply -f /tmp/service-account.yaml
            k3s kubectl apply -f /tmp/cluster-role.yaml
            k3s kubectl apply -f /tmp/cluster-role-binding.yaml
            k3s kubectl apply -f /tmp/deployment-scheduler.yaml
            k3s kubectl apply -f /tmp/ram_price.yaml
            k3s kubectl apply -f /tmp/storage_price.yaml
            k3s kubectl apply -f /tmp/vcpu_price.yaml
            k3s kubectl apply -f /tmp/vgpu_price.yaml

            mkdir -p ~/.kube
            cp /etc/rancher/k3s/k3s.yaml ~/.kube/config
            chown $(whoami):$(whoami) ~/.kube/config
            chmod 600 ~/.kube/config

            echo "[READY] K3s cluster is up and running on $(hostname)."

            while true; do
                sync
                echo 3 > /proc/sys/vm/drop_caches
                sleep 100000
            done &

            sleep infinity
          '

    serf3:
      kind: linux
      image: abdullahmuzlim279/k3s-serf-node:warmcache-test
      env:
        CLAB_LINUX_PRIVILEGED: "true"
      binds:
        - /sys/fs/cgroup:/sys/fs/cgroup:rw
        - /lib/modules:/lib/modules:ro
        - /dev:/dev
      cmd: >
          bash -c '
            set -e
            echo "[INIT] Preparing system..."
            ulimit -n 65536
            sysctl -w fs.inotify.max_user_instances=4096
            sysctl -w fs.inotify.max_user_watches=524288
            sysctl -w fs.file-max=2097152

            echo 0 > /sys/fs/cgroup/cpu.pressure || true
            echo 0 > /sys/fs/cgroup/memory.pressure || true

            echo "[NET] Waiting for eth1 to be created..."
            until ip link show eth1 >/dev/null 2>&1; do
                sleep 1
            done
            echo "[NET] eth1 detected."

            ip link set eth1 up
            #ip addr add 10.0.1.13/24 brd 10.0.1.255 dev eth1
            ip link set eth1 mtu 1400

            sleep $((RANDOM % 10 + 5))

            echo "[INIT] Launching optimized K3s server with relaxed cgroups..."
            k3s server \
              --node-name serf3 \
              --disable traefik \
              --disable servicelb \
              --disable local-storage \
              --disable metrics-server \
              --disable-cloud-controller \
              --disable-network-policy \
              --disable-helm-controller \
              --snapshotter native \
              --tls-san 10.0.1.13 \
              --kubelet-arg=cgroup-root=/ \
              --kubelet-arg=cgroups-per-qos=false \
              --kubelet-arg=enforce-node-allocatable= \
              --v=0 &

            sleep 20
            chmod 666 /etc/rancher/k3s/k3s.yaml
            export KUBECONFIG=/etc/rancher/k3s/k3s.yaml

            echo "[INIT] Waiting for containerd to be ready..."
            until /usr/local/bin/k3s ctr version >/dev/null 2>&1; do
                echo "  containerd not yet ready, retrying..."
                sleep 3
            done
            echo "Containerd is ready."

            echo "[INIT] Importing cached images..."
            for f in /opt/k3s-images/*.tar; do
                echo "Loading $f ..."
                /usr/local/bin/k3s ctr images import "$f" || true
            done

            k3s kubectl apply -f /tmp/qos-controller-daemonset.yaml
            k3s kubectl apply -f /tmp/service-account.yaml
            k3s kubectl apply -f /tmp/cluster-role.yaml
            k3s kubectl apply -f /tmp/cluster-role-binding.yaml
            k3s kubectl apply -f /tmp/deployment-scheduler.yaml
            k3s kubectl apply -f /tmp/ram_price.yaml
            k3s kubectl apply -f /tmp/storage_price.yaml
            k3s kubectl apply -f /tmp/vcpu_price.yaml
            k3s kubectl apply -f /tmp/vgpu_price.yaml

            mkdir -p ~/.kube
            cp /etc/rancher/k3s/k3s.yaml ~/.kube/config
            chown $(whoami):$(whoami) ~/.kube/config
            chmod 600 ~/.kube/config

            echo "[READY] K3s cluster is up and running on $(hostname)."

            while true; do
                sync
                echo 3 > /proc/sys/vm/drop_caches
                sleep 100000
            done &

            sleep infinity
          '

    serf4:
      kind: linux
      image: abdullahmuzlim279/k3s-serf-node:warmcache-test
      env:
        CLAB_LINUX_PRIVILEGED: "true"
      binds:
        - /sys/fs/cgroup:/sys/fs/cgroup:rw
        - /lib/modules:/lib/modules:ro
        - /dev:/dev
      cmd: >
          bash -c '
            set -e
            echo "[INIT] Preparing system..."
            ulimit -n 65536
            sysctl -w fs.inotify.max_user_instances=4096
            sysctl -w fs.inotify.max_user_watches=524288
            sysctl -w fs.file-max=2097152

            echo 0 > /sys/fs/cgroup/cpu.pressure || true
            echo 0 > /sys/fs/cgroup/memory.pressure || true

            echo "[NET] Waiting for eth1 to be created..."
            until ip link show eth1 >/dev/null 2>&1; do
                sleep 1
            done
            echo "[NET] eth1 detected."

            ip link set eth1 up
            #ip addr add 10.0.1.14/24 brd 10.0.1.255 dev eth1
            ip link set eth1 mtu 1400

            sleep $((RANDOM % 10 + 5))

            echo "[INIT] Launching optimized K3s server with relaxed cgroups..."
            k3s server \
              --node-name serf4 \
              --disable traefik \
              --disable servicelb \
              --disable local-storage \
              --disable metrics-server \
              --disable-cloud-controller \
              --disable-network-policy \
              --disable-helm-controller \
              --snapshotter native \
              --tls-san 10.0.1.14 \
              --kubelet-arg=cgroup-root=/ \
              --kubelet-arg=cgroups-per-qos=false \
              --kubelet-arg=enforce-node-allocatable= \
              --v=0 &

            sleep 20
            chmod 666 /etc/rancher/k3s/k3s.yaml
            export KUBECONFIG=/etc/rancher/k3s/k3s.yaml

            echo "[INIT] Waiting for containerd to be ready..."
            until /usr/local/bin/k3s ctr version >/dev/null 2>&1; do
                echo "  containerd not yet ready, retrying..."
                sleep 3
            done
            echo "Containerd is ready."

            echo "[INIT] Importing cached images..."
            for f in /opt/k3s-images/*.tar; do
                echo "Loading $f ..."
                /usr/local/bin/k3s ctr images import "$f" || true
            done

            k3s kubectl apply -f /tmp/qos-controller-daemonset.yaml
            k3s kubectl apply -f /tmp/service-account.yaml
            k3s kubectl apply -f /tmp/cluster-role.yaml
            k3s kubectl apply -f /tmp/cluster-role-binding.yaml
            k3s kubectl apply -f /tmp/deployment-scheduler.yaml
            k3s kubectl apply -f /tmp/ram_price.yaml
            k3s kubectl apply -f /tmp/storage_price.yaml
            k3s kubectl apply -f /tmp/vcpu_price.yaml
            k3s kubectl apply -f /tmp/vgpu_price.yaml

            mkdir -p ~/.kube
            cp /etc/rancher/k3s/k3s.yaml ~/.kube/config
            chown $(whoami):$(whoami) ~/.kube/config
            chmod 600 ~/.kube/config

            echo "[READY] K3s cluster is up and running on $(hostname)."

            while true; do
                sync
                echo 3 > /proc/sys/vm/drop_caches
                sleep 100000
            done &

            sleep infinity
          '

    serf5:
      kind: linux
      image: abdullahmuzlim279/k3s-serf-node:warmcache-test
      env:
        CLAB_LINUX_PRIVILEGED: "true"
      binds:
        - /sys/fs/cgroup:/sys/fs/cgroup:rw
        - /lib/modules:/lib/modules:ro
        - /dev:/dev
      cmd: >
          bash -c '
            set -e
            echo "[INIT] Preparing system..."
            ulimit -n 65536
            sysctl -w fs.inotify.max_user_instances=4096
            sysctl -w fs.inotify.max_user_watches=524288
            sysctl -w fs.file-max=2097152

            echo 0 > /sys/fs/cgroup/cpu.pressure || true
            echo 0 > /sys/fs/cgroup/memory.pressure || true

            echo "[NET] Waiting for eth1 to be created..."
            until ip link show eth1 >/dev/null 2>&1; do
                sleep 1
            done
            echo "[NET] eth1 detected."

            ip link set eth1 up
            #ip addr add 10.0.1.15/24 brd 10.0.1.255 dev eth1
            ip link set eth1 mtu 1400

            sleep $((RANDOM % 10 + 5))

            echo "[INIT] Launching optimized K3s server with relaxed cgroups..."
            k3s server \
              --node-name serf5 \
              --disable traefik \
              --disable servicelb \
              --disable local-storage \
              --disable metrics-server \
              --disable-cloud-controller \
              --disable-network-policy \
              --disable-helm-controller \
              --snapshotter native \
              --tls-san 10.0.1.15 \
              --kubelet-arg=cgroup-root=/ \
              --kubelet-arg=cgroups-per-qos=false \
              --kubelet-arg=enforce-node-allocatable= \
              --v=0 &

            sleep 20
            chmod 666 /etc/rancher/k3s/k3s.yaml
            export KUBECONFIG=/etc/rancher/k3s/k3s.yaml

            echo "[INIT] Waiting for containerd to be ready..."
            until /usr/local/bin/k3s ctr version >/dev/null 2>&1; do
                echo "  containerd not yet ready, retrying..."
                sleep 3
            done
            echo "Containerd is ready."

            echo "[INIT] Importing cached images..."
            for f in /opt/k3s-images/*.tar; do
                echo "Loading $f ..."
                /usr/local/bin/k3s ctr images import "$f" || true
            done

            k3s kubectl apply -f /tmp/qos-controller-daemonset.yaml
            k3s kubectl apply -f /tmp/service-account.yaml
            k3s kubectl apply -f /tmp/cluster-role.yaml
            k3s kubectl apply -f /tmp/cluster-role-binding.yaml
            k3s kubectl apply -f /tmp/deployment-scheduler.yaml
            k3s kubectl apply -f /tmp/ram_price.yaml
            k3s kubectl apply -f /tmp/storage_price.yaml
            k3s kubectl apply -f /tmp/vcpu_price.yaml
            k3s kubectl apply -f /tmp/vgpu_price.yaml

            mkdir -p ~/.kube
            cp /etc/rancher/k3s/k3s.yaml ~/.kube/config
            chown $(whoami):$(whoami) ~/.kube/config
            chmod 600 ~/.kube/config

            echo "[READY] K3s cluster is up and running on $(hostname)."

            while true; do
                sync
                echo 3 > /proc/sys/vm/drop_caches
                sleep 100000
            done &

            sleep infinity
          '

    serf6:
      kind: linux
      image: abdullahmuzlim279/k3s-serf-node:warmcache-test
      env:
        CLAB_LINUX_PRIVILEGED: "true"
      binds:
        - /sys/fs/cgroup:/sys/fs/cgroup:rw
        - /lib/modules:/lib/modules:ro
        - /dev:/dev
      cmd: >
          bash -c '
            set -e
            echo "[INIT] Preparing system..."
            ulimit -n 65536
            sysctl -w fs.inotify.max_user_instances=4096
            sysctl -w fs.inotify.max_user_watches=524288
            sysctl -w fs.file-max=2097152

            echo 0 > /sys/fs/cgroup/cpu.pressure || true
            echo 0 > /sys/fs/cgroup/memory.pressure || true

            echo "[NET] Waiting for eth1 to be created..."
            until ip link show eth1 >/dev/null 2>&1; do
                sleep 1
            done
            echo "[NET] eth1 detected."

            ip link set eth1 up
            #ip addr add 10.0.1.16/24 brd 10.0.1.255 dev eth1
            ip link set eth1 mtu 1400

            sleep $((RANDOM % 10 + 5))

            echo "[INIT] Launching optimized K3s server with relaxed cgroups..."
            k3s server \
              --node-name serf6 \
              --disable traefik \
              --disable servicelb \
              --disable local-storage \
              --disable metrics-server \
              --disable-cloud-controller \
              --disable-network-policy \
              --disable-helm-controller \
              --snapshotter native \
              --tls-san 10.0.1.16 \
              --kubelet-arg=cgroup-root=/ \
              --kubelet-arg=cgroups-per-qos=false \
              --kubelet-arg=enforce-node-allocatable= \
              --v=0 &

            sleep 20
            chmod 666 /etc/rancher/k3s/k3s.yaml
            export KUBECONFIG=/etc/rancher/k3s/k3s.yaml

            echo "[INIT] Waiting for containerd to be ready..."
            until /usr/local/bin/k3s ctr version >/dev/null 2>&1; do
                echo "  containerd not yet ready, retrying..."
                sleep 3
            done
            echo "Containerd is ready."

            echo "[INIT] Importing cached images..."
            for f in /opt/k3s-images/*.tar; do
                echo "Loading $f ..."
                /usr/local/bin/k3s ctr images import "$f" || true
            done

            k3s kubectl apply -f /tmp/qos-controller-daemonset.yaml
            k3s kubectl apply -f /tmp/service-account.yaml
            k3s kubectl apply -f /tmp/cluster-role.yaml
            k3s kubectl apply -f /tmp/cluster-role-binding.yaml
            k3s kubectl apply -f /tmp/deployment-scheduler.yaml
            k3s kubectl apply -f /tmp/ram_price.yaml
            k3s kubectl apply -f /tmp/storage_price.yaml
            k3s kubectl apply -f /tmp/vcpu_price.yaml
            k3s kubectl apply -f /tmp/vgpu_price.yaml

            mkdir -p ~/.kube
            cp /etc/rancher/k3s/k3s.yaml ~/.kube/config
            chown $(whoami):$(whoami) ~/.kube/config
            chmod 600 ~/.kube/config

            echo "[READY] K3s cluster is up and running on $(hostname)."

            while true; do
                sync
                echo 3 > /proc/sys/vm/drop_caches
                sleep 100000
            done &

            sleep infinity
          '

    serf7:
      kind: linux
      image: abdullahmuzlim279/k3s-serf-node:warmcache-test
      env:
        CLAB_LINUX_PRIVILEGED: "true"
      binds:
        - /sys/fs/cgroup:/sys/fs/cgroup:rw
        - /lib/modules:/lib/modules:ro
        - /dev:/dev
      cmd: >
          bash -c '
            set -e
            echo "[INIT] Preparing system..."
            ulimit -n 65536
            sysctl -w fs.inotify.max_user_instances=4096
            sysctl -w fs.inotify.max_user_watches=524288
            sysctl -w fs.file-max=2097152

            echo 0 > /sys/fs/cgroup/cpu.pressure || true
            echo 0 > /sys/fs/cgroup/memory.pressure || true

            echo "[NET] Waiting for eth1 to be created..."
            until ip link show eth1 >/dev/null 2>&1; do
                sleep 1
            done
            echo "[NET] eth1 detected."

            ip link set eth1 up
            #ip addr add 10.0.1.17/24 brd 10.0.1.255 dev eth1
            ip link set eth1 mtu 1400

            sleep $((RANDOM % 10 + 5))

            echo "[INIT] Launching optimized K3s server with relaxed cgroups..."
            k3s server \
              --node-name serf7 \
              --disable traefik \
              --disable servicelb \
              --disable local-storage \
              --disable metrics-server \
              --disable-cloud-controller \
              --disable-network-policy \
              --disable-helm-controller \
              --snapshotter native \
              --tls-san 10.0.1.17 \
              --kubelet-arg=cgroup-root=/ \
              --kubelet-arg=cgroups-per-qos=false \
              --kubelet-arg=enforce-node-allocatable= \
              --v=0 &

            sleep 20
            chmod 666 /etc/rancher/k3s/k3s.yaml
            export KUBECONFIG=/etc/rancher/k3s/k3s.yaml

            echo "[INIT] Waiting for containerd to be ready..."
            until /usr/local/bin/k3s ctr version >/dev/null 2>&1; do
                echo "  containerd not yet ready, retrying..."
                sleep 3
            done
            echo "Containerd is ready."

            echo "[INIT] Importing cached images..."
            for f in /opt/k3s-images/*.tar; do
                echo "Loading $f ..."
                /usr/local/bin/k3s ctr images import "$f" || true
            done

            k3s kubectl apply -f /tmp/qos-controller-daemonset.yaml
            k3s kubectl apply -f /tmp/service-account.yaml
            k3s kubectl apply -f /tmp/cluster-role.yaml
            k3s kubectl apply -f /tmp/cluster-role-binding.yaml
            k3s kubectl apply -f /tmp/deployment-scheduler.yaml
            k3s kubectl apply -f /tmp/ram_price.yaml
            k3s kubectl apply -f /tmp/storage_price.yaml
            k3s kubectl apply -f /tmp/vcpu_price.yaml
            k3s kubectl apply -f /tmp/vgpu_price.yaml

            mkdir -p ~/.kube
            cp /etc/rancher/k3s/k3s.yaml ~/.kube/config
            chown $(whoami):$(whoami) ~/.kube/config
            chmod 600 ~/.kube/config

            echo "[READY] K3s cluster is up and running on $(hostname)."

            while true; do
                sync
                echo 3 > /proc/sys/vm/drop_caches
                sleep 100000
            done &

            sleep infinity
          '

    serf8:
      kind: linux
      image: abdullahmuzlim279/k3s-serf-node:warmcache-test
      env:
        CLAB_LINUX_PRIVILEGED: "true"
      binds:
        - /sys/fs/cgroup:/sys/fs/cgroup:rw
        - /lib/modules:/lib/modules:ro
        - /dev:/dev
      cmd: >
          bash -c '
            set -e
            echo "[INIT] Preparing system..."
            ulimit -n 65536
            sysctl -w fs.inotify.max_user_instances=4096
            sysctl -w fs.inotify.max_user_watches=524288
            sysctl -w fs.file-max=2097152

            echo 0 > /sys/fs/cgroup/cpu.pressure || true
            echo 0 > /sys/fs/cgroup/memory.pressure || true

            echo "[NET] Waiting for eth1 to be created..."
            until ip link show eth1 >/dev/null 2>&1; do
                sleep 1
            done
            echo "[NET] eth1 detected."

            ip link set eth1 up
            #ip addr add 10.0.1.18/24 brd 10.0.1.255 dev eth1
            ip link set eth1 mtu 1400

            sleep $((RANDOM % 10 + 5))

            echo "[INIT] Launching optimized K3s server with relaxed cgroups..."
            k3s server \
              --node-name serf8 \
              --disable traefik \
              --disable servicelb \
              --disable local-storage \
              --disable metrics-server \
              --disable-cloud-controller \
              --disable-network-policy \
              --disable-helm-controller \
              --snapshotter native \
              --tls-san 10.0.1.18 \
              --kubelet-arg=cgroup-root=/ \
              --kubelet-arg=cgroups-per-qos=false \
              --kubelet-arg=enforce-node-allocatable= \
              --v=0 &

            sleep 20
            chmod 666 /etc/rancher/k3s/k3s.yaml
            export KUBECONFIG=/etc/rancher/k3s/k3s.yaml

            echo "[INIT] Waiting for containerd to be ready..."
            until /usr/local/bin/k3s ctr version >/dev/null 2>&1; do
                echo "  containerd not yet ready, retrying..."
                sleep 3
            done
            echo "Containerd is ready."

            echo "[INIT] Importing cached images..."
            for f in /opt/k3s-images/*.tar; do
                echo "Loading $f ..."
                /usr/local/bin/k3s ctr images import "$f" || true
            done

            k3s kubectl apply -f /tmp/qos-controller-daemonset.yaml
            k3s kubectl apply -f /tmp/service-account.yaml
            k3s kubectl apply -f /tmp/cluster-role.yaml
            k3s kubectl apply -f /tmp/cluster-role-binding.yaml
            k3s kubectl apply -f /tmp/deployment-scheduler.yaml
            k3s kubectl apply -f /tmp/ram_price.yaml
            k3s kubectl apply -f /tmp/storage_price.yaml
            k3s kubectl apply -f /tmp/vcpu_price.yaml
            k3s kubectl apply -f /tmp/vgpu_price.yaml

            mkdir -p ~/.kube
            cp /etc/rancher/k3s/k3s.yaml ~/.kube/config
            chown $(whoami):$(whoami) ~/.kube/config
            chmod 600 ~/.kube/config

            echo "[READY] K3s cluster is up and running on $(hostname)."

            while true; do
                sync
                echo 3 > /proc/sys/vm/drop_caches
                sleep 100000
            done &

            sleep infinity
          '

    serf9:
      kind: linux
      image: abdullahmuzlim279/k3s-serf-node:warmcache-test
      env:
        CLAB_LINUX_PRIVILEGED: "true"
      binds:
        - /sys/fs/cgroup:/sys/fs/cgroup:rw
        - /lib/modules:/lib/modules:ro
        - /dev:/dev
      cmd: >
          bash -c '
            set -e
            echo "[INIT] Preparing system..."
            ulimit -n 65536
            sysctl -w fs.inotify.max_user_instances=4096
            sysctl -w fs.inotify.max_user_watches=524288
            sysctl -w fs.file-max=2097152

            echo 0 > /sys/fs/cgroup/cpu.pressure || true
            echo 0 > /sys/fs/cgroup/memory.pressure || true

            echo "[NET] Waiting for eth1 to be created..."
            until ip link show eth1 >/dev/null 2>&1; do
                sleep 1
            done
            echo "[NET] eth1 detected."

            ip link set eth1 up
            #ip addr add 10.0.1.19/24 brd 10.0.1.255 dev eth1
            ip link set eth1 mtu 1400

            sleep $((RANDOM % 10 + 5))

            echo "[INIT] Launching optimized K3s server with relaxed cgroups..."
            k3s server \
              --node-name serf9 \
              --disable traefik \
              --disable servicelb \
              --disable local-storage \
              --disable metrics-server \
              --disable-cloud-controller \
              --disable-network-policy \
              --disable-helm-controller \
              --snapshotter native \
              --tls-san 10.0.1.19 \
              --kubelet-arg=cgroup-root=/ \
              --kubelet-arg=cgroups-per-qos=false \
              --kubelet-arg=enforce-node-allocatable= \
              --v=0 &

            sleep 20
            chmod 666 /etc/rancher/k3s/k3s.yaml
            export KUBECONFIG=/etc/rancher/k3s/k3s.yaml

            echo "[INIT] Waiting for containerd to be ready..."
            until /usr/local/bin/k3s ctr version >/dev/null 2>&1; do
                echo "  containerd not yet ready, retrying..."
                sleep 3
            done
            echo "Containerd is ready."

            echo "[INIT] Importing cached images..."
            for f in /opt/k3s-images/*.tar; do
                echo "Loading $f ..."
                /usr/local/bin/k3s ctr images import "$f" || true
            done

            k3s kubectl apply -f /tmp/qos-controller-daemonset.yaml
            k3s kubectl apply -f /tmp/service-account.yaml
            k3s kubectl apply -f /tmp/cluster-role.yaml
            k3s kubectl apply -f /tmp/cluster-role-binding.yaml
            k3s kubectl apply -f /tmp/deployment-scheduler.yaml
            k3s kubectl apply -f /tmp/ram_price.yaml
            k3s kubectl apply -f /tmp/storage_price.yaml
            k3s kubectl apply -f /tmp/vcpu_price.yaml
            k3s kubectl apply -f /tmp/vgpu_price.yaml

            mkdir -p ~/.kube
            cp /etc/rancher/k3s/k3s.yaml ~/.kube/config
            chown $(whoami):$(whoami) ~/.kube/config
            chmod 600 ~/.kube/config

            echo "[READY] K3s cluster is up and running on $(hostname)."

            while true; do
                sync
                echo 3 > /proc/sys/vm/drop_caches
                sleep 100000
            done &

            sleep infinity
          '

    serf10:
      kind: linux
      image: abdullahmuzlim279/k3s-serf-node:warmcache-test
      env:
        CLAB_LINUX_PRIVILEGED: "true"
      binds:
        - /sys/fs/cgroup:/sys/fs/cgroup:rw
        - /lib/modules:/lib/modules:ro
        - /dev:/dev
      cmd: >
          bash -c '
            set -e
            echo "[INIT] Preparing system..."
            ulimit -n 65536
            sysctl -w fs.inotify.max_user_instances=4096
            sysctl -w fs.inotify.max_user_watches=524288
            sysctl -w fs.file-max=2097152

            echo 0 > /sys/fs/cgroup/cpu.pressure || true
            echo 0 > /sys/fs/cgroup/memory.pressure || true

            echo "[NET] Waiting for eth1 to be created..."
            until ip link show eth1 >/dev/null 2>&1; do
                sleep 1
            done
            echo "[NET] eth1 detected."

            ip link set eth1 up
            #ip addr add 10.0.1.20/24 brd 10.0.1.255 dev eth1
            ip link set eth1 mtu 1400

            sleep $((RANDOM % 10 + 5))

            echo "[INIT] Launching optimized K3s server with relaxed cgroups..."
            k3s server \
              --node-name serf10 \
              --disable traefik \
              --disable servicelb \
              --disable local-storage \
              --disable metrics-server \
              --disable-cloud-controller \
              --disable-network-policy \
              --disable-helm-controller \
              --snapshotter native \
              --tls-san 10.0.1.20 \
              --kubelet-arg=cgroup-root=/ \
              --kubelet-arg=cgroups-per-qos=false \
              --kubelet-arg=enforce-node-allocatable= \
              --v=0 &

            sleep 20
            chmod 666 /etc/rancher/k3s/k3s.yaml
            export KUBECONFIG=/etc/rancher/k3s/k3s.yaml

            echo "[INIT] Waiting for containerd to be ready..."
            until /usr/local/bin/k3s ctr version >/dev/null 2>&1; do
                echo "  containerd not yet ready, retrying..."
                sleep 3
            done
            echo "Containerd is ready."

            echo "[INIT] Importing cached images..."
            for f in /opt/k3s-images/*.tar; do
                echo "Loading $f ..."
                /usr/local/bin/k3s ctr images import "$f" || true
            done

            k3s kubectl apply -f /tmp/qos-controller-daemonset.yaml
            k3s kubectl apply -f /tmp/service-account.yaml
            k3s kubectl apply -f /tmp/cluster-role.yaml
            k3s kubectl apply -f /tmp/cluster-role-binding.yaml
            k3s kubectl apply -f /tmp/deployment-scheduler.yaml
            k3s kubectl apply -f /tmp/ram_price.yaml
            k3s kubectl apply -f /tmp/storage_price.yaml
            k3s kubectl apply -f /tmp/vcpu_price.yaml
            k3s kubectl apply -f /tmp/vgpu_price.yaml

            mkdir -p ~/.kube
            cp /etc/rancher/k3s/k3s.yaml ~/.kube/config
            chown $(whoami):$(whoami) ~/.kube/config
            chmod 600 ~/.kube/config

            echo "[READY] K3s cluster is up and running on $(hostname)."

            while true; do
                sync
                echo 3 > /proc/sys/vm/drop_caches
                sleep 100000
            done &

            sleep infinity
          '

    serf11:
      kind: linux
      image: abdullahmuzlim279/k3s-serf-node:warmcache-test
      env:
        CLAB_LINUX_PRIVILEGED: "true"
      binds:
        - /sys/fs/cgroup:/sys/fs/cgroup:rw
        - /lib/modules:/lib/modules:ro
        - /dev:/dev
      cmd: >
          bash -c '
            set -e
            echo "[INIT] Preparing system..."
            ulimit -n 65536
            sysctl -w fs.inotify.max_user_instances=4096
            sysctl -w fs.inotify.max_user_watches=524288
            sysctl -w fs.file-max=2097152

            echo 0 > /sys/fs/cgroup/cpu.pressure || true
            echo 0 > /sys/fs/cgroup/memory.pressure || true

            echo "[NET] Waiting for eth1 to be created..."
            until ip link show eth1 >/dev/null 2>&1; do
                sleep 1
            done
            echo "[NET] eth1 detected."

            ip link set eth1 up
            #ip addr add 10.0.1.21/24 brd 10.0.1.255 dev eth1
            ip link set eth1 mtu 1400

            sleep $((RANDOM % 10 + 5))

            echo "[INIT] Launching optimized K3s server with relaxed cgroups..."
            k3s server \
              --node-name serf11 \
              --disable traefik \
              --disable servicelb \
              --disable local-storage \
              --disable metrics-server \
              --disable-cloud-controller \
              --disable-network-policy \
              --disable-helm-controller \
              --snapshotter native \
              --tls-san 10.0.1.21 \
              --kubelet-arg=cgroup-root=/ \
              --kubelet-arg=cgroups-per-qos=false \
              --kubelet-arg=enforce-node-allocatable= \
              --v=0 &

            sleep 20
            chmod 666 /etc/rancher/k3s/k3s.yaml
            export KUBECONFIG=/etc/rancher/k3s/k3s.yaml

            echo "[INIT] Waiting for containerd to be ready..."
            until /usr/local/bin/k3s ctr version >/dev/null 2>&1; do
                echo "  containerd not yet ready, retrying..."
                sleep 3
            done
            echo "Containerd is ready."

            echo "[INIT] Importing cached images..."
            for f in /opt/k3s-images/*.tar; do
                echo "Loading $f ..."
                /usr/local/bin/k3s ctr images import "$f" || true
            done

            k3s kubectl apply -f /tmp/qos-controller-daemonset.yaml
            k3s kubectl apply -f /tmp/service-account.yaml
            k3s kubectl apply -f /tmp/cluster-role.yaml
            k3s kubectl apply -f /tmp/cluster-role-binding.yaml
            k3s kubectl apply -f /tmp/deployment-scheduler.yaml
            k3s kubectl apply -f /tmp/ram_price.yaml
            k3s kubectl apply -f /tmp/storage_price.yaml
            k3s kubectl apply -f /tmp/vcpu_price.yaml
            k3s kubectl apply -f /tmp/vgpu_price.yaml

            mkdir -p ~/.kube
            cp /etc/rancher/k3s/k3s.yaml ~/.kube/config
            chown $(whoami):$(whoami) ~/.kube/config
            chmod 600 ~/.kube/config

            echo "[READY] K3s cluster is up and running on $(hostname)."

            while true; do
                sync
                echo 3 > /proc/sys/vm/drop_caches
                sleep 100000
            done &

            sleep infinity
          '

    serf12:
      kind: linux
      image: abdullahmuzlim279/k3s-serf-node:warmcache-test
      env:
        CLAB_LINUX_PRIVILEGED: "true"
      binds:
        - /sys/fs/cgroup:/sys/fs/cgroup:rw
        - /lib/modules:/lib/modules:ro
        - /dev:/dev
      cmd: >
          bash -c '
            set -e
            echo "[INIT] Preparing system..."
            ulimit -n 65536
            sysctl -w fs.inotify.max_user_instances=4096
            sysctl -w fs.inotify.max_user_watches=524288
            sysctl -w fs.file-max=2097152

            echo 0 > /sys/fs/cgroup/cpu.pressure || true
            echo 0 > /sys/fs/cgroup/memory.pressure || true

            echo "[NET] Waiting for eth1 to be created..."
            until ip link show eth1 >/dev/null 2>&1; do
                sleep 1
            done
            echo "[NET] eth1 detected."

            ip link set eth1 up
            #ip addr add 10.0.1.22/24 brd 10.0.1.255 dev eth1
            ip link set eth1 mtu 1400

            sleep $((RANDOM % 10 + 5))

            echo "[INIT] Launching optimized K3s server with relaxed cgroups..."
            k3s server \
              --node-name serf12 \
              --disable traefik \
              --disable servicelb \
              --disable local-storage \
              --disable metrics-server \
              --disable-cloud-controller \
              --disable-network-policy \
              --disable-helm-controller \
              --snapshotter native \
              --tls-san 10.0.1.22 \
              --kubelet-arg=cgroup-root=/ \
              --kubelet-arg=cgroups-per-qos=false \
              --kubelet-arg=enforce-node-allocatable= \
              --v=0 &

            sleep 20
            chmod 666 /etc/rancher/k3s/k3s.yaml
            export KUBECONFIG=/etc/rancher/k3s/k3s.yaml

            echo "[INIT] Waiting for containerd to be ready..."
            until /usr/local/bin/k3s ctr version >/dev/null 2>&1; do
                echo "  containerd not yet ready, retrying..."
                sleep 3
            done
            echo "Containerd is ready."

            echo "[INIT] Importing cached images..."
            for f in /opt/k3s-images/*.tar; do
                echo "Loading $f ..."
                /usr/local/bin/k3s ctr images import "$f" || true
            done

            k3s kubectl apply -f /tmp/qos-controller-daemonset.yaml
            k3s kubectl apply -f /tmp/service-account.yaml
            k3s kubectl apply -f /tmp/cluster-role.yaml
            k3s kubectl apply -f /tmp/cluster-role-binding.yaml
            k3s kubectl apply -f /tmp/deployment-scheduler.yaml
            k3s kubectl apply -f /tmp/ram_price.yaml
            k3s kubectl apply -f /tmp/storage_price.yaml
            k3s kubectl apply -f /tmp/vcpu_price.yaml
            k3s kubectl apply -f /tmp/vgpu_price.yaml

            mkdir -p ~/.kube
            cp /etc/rancher/k3s/k3s.yaml ~/.kube/config
            chown $(whoami):$(whoami) ~/.kube/config
            chmod 600 ~/.kube/config

            echo "[READY] K3s cluster is up and running on $(hostname)."

            while true; do
                sync
                echo 3 > /proc/sys/vm/drop_caches
                sleep 100000
            done &

            sleep infinity
          '

    serf13:
      kind: linux
      image: abdullahmuzlim279/k3s-serf-node:warmcache-test
      env:
        CLAB_LINUX_PRIVILEGED: "true"
      binds:
        - /sys/fs/cgroup:/sys/fs/cgroup:rw
        - /lib/modules:/lib/modules:ro
        - /dev:/dev
      cmd: >
          bash -c '
            set -e
            echo "[INIT] Preparing system..."
            ulimit -n 65536
            sysctl -w fs.inotify.max_user_instances=4096
            sysctl -w fs.inotify.max_user_watches=524288
            sysctl -w fs.file-max=2097152

            echo 0 > /sys/fs/cgroup/cpu.pressure || true
            echo 0 > /sys/fs/cgroup/memory.pressure || true

            echo "[NET] Waiting for eth1 to be created..."
            until ip link show eth1 >/dev/null 2>&1; do
                sleep 1
            done
            echo "[NET] eth1 detected."

            ip link set eth1 up
            #ip addr add 10.0.1.23/24 brd 10.0.1.255 dev eth1
            ip link set eth1 mtu 1400

            sleep $((RANDOM % 10 + 5))

            echo "[INIT] Launching optimized K3s server with relaxed cgroups..."
            k3s server \
              --node-name serf13 \
              --disable traefik \
              --disable servicelb \
              --disable local-storage \
              --disable metrics-server \
              --disable-cloud-controller \
              --disable-network-policy \
              --disable-helm-controller \
              --snapshotter native \
              --tls-san 10.0.2.11 \
              --kubelet-arg=cgroup-root=/ \
              --kubelet-arg=cgroups-per-qos=false \
              --kubelet-arg=enforce-node-allocatable= \
              --v=0 &

            sleep 20
            chmod 666 /etc/rancher/k3s/k3s.yaml
            export KUBECONFIG=/etc/rancher/k3s/k3s.yaml

            echo "[INIT] Waiting for containerd to be ready..."
            until /usr/local/bin/k3s ctr version >/dev/null 2>&1; do
                echo "  containerd not yet ready, retrying..."
                sleep 3
            done
            echo "Containerd is ready."

            echo "[INIT] Importing cached images..."
            for f in /opt/k3s-images/*.tar; do
                echo "Loading $f ..."
                /usr/local/bin/k3s ctr images import "$f" || true
            done

            k3s kubectl apply -f /tmp/qos-controller-daemonset.yaml
            k3s kubectl apply -f /tmp/service-account.yaml
            k3s kubectl apply -f /tmp/cluster-role.yaml
            k3s kubectl apply -f /tmp/cluster-role-binding.yaml
            k3s kubectl apply -f /tmp/deployment-scheduler.yaml
            k3s kubectl apply -f /tmp/ram_price.yaml
            k3s kubectl apply -f /tmp/storage_price.yaml
            k3s kubectl apply -f /tmp/vcpu_price.yaml
            k3s kubectl apply -f /tmp/vgpu_price.yaml

            mkdir -p ~/.kube
            cp /etc/rancher/k3s/k3s.yaml ~/.kube/config
            chown $(whoami):$(whoami) ~/.kube/config
            chmod 600 ~/.kube/config

            echo "[READY] K3s cluster is up and running on $(hostname)."

            while true; do
                sync
                echo 3 > /proc/sys/vm/drop_caches
                sleep 100000
            done &

            sleep infinity
          '

    serf14:
      kind: linux
      image: abdullahmuzlim279/k3s-serf-node:warmcache-test
      env:
        CLAB_LINUX_PRIVILEGED: "true"
      binds:
        - /sys/fs/cgroup:/sys/fs/cgroup:rw
        - /lib/modules:/lib/modules:ro
        - /dev:/dev
      cmd: >
          bash -c '
            set -e
            echo "[INIT] Preparing system..."
            ulimit -n 65536
            sysctl -w fs.inotify.max_user_instances=4096
            sysctl -w fs.inotify.max_user_watches=524288
            sysctl -w fs.file-max=2097152

            echo 0 > /sys/fs/cgroup/cpu.pressure || true
            echo 0 > /sys/fs/cgroup/memory.pressure || true

            echo "[NET] Waiting for eth1 to be created..."
            until ip link show eth1 >/dev/null 2>&1; do
                sleep 1
            done
            echo "[NET] eth1 detected."

            ip link set eth1 up
            #ip addr add 10.0.1.24/24 brd 10.0.1.255 dev eth1
            ip link set eth1 mtu 1400

            sleep $((RANDOM % 10 + 5))

            echo "[INIT] Launching optimized K3s server with relaxed cgroups..."
            k3s server \
              --node-name serf14 \
              --disable traefik \
              --disable servicelb \
              --disable local-storage \
              --disable metrics-server \
              --disable-cloud-controller \
              --disable-network-policy \
              --disable-helm-controller \
              --snapshotter native \
              --tls-san 10.0.2.12 \
              --kubelet-arg=cgroup-root=/ \
              --kubelet-arg=cgroups-per-qos=false \
              --kubelet-arg=enforce-node-allocatable= \
              --v=0 &

            sleep 20
            chmod 666 /etc/rancher/k3s/k3s.yaml
            export KUBECONFIG=/etc/rancher/k3s/k3s.yaml

            echo "[INIT] Waiting for containerd to be ready..."
            until /usr/local/bin/k3s ctr version >/dev/null 2>&1; do
                echo "  containerd not yet ready, retrying..."
                sleep 3
            done
            echo "Containerd is ready."

            echo "[INIT] Importing cached images..."
            for f in /opt/k3s-images/*.tar; do
                echo "Loading $f ..."
                /usr/local/bin/k3s ctr images import "$f" || true
            done

            k3s kubectl apply -f /tmp/qos-controller-daemonset.yaml
            k3s kubectl apply -f /tmp/service-account.yaml
            k3s kubectl apply -f /tmp/cluster-role.yaml
            k3s kubectl apply -f /tmp/cluster-role-binding.yaml
            k3s kubectl apply -f /tmp/deployment-scheduler.yaml
            k3s kubectl apply -f /tmp/ram_price.yaml
            k3s kubectl apply -f /tmp/storage_price.yaml
            k3s kubectl apply -f /tmp/vcpu_price.yaml
            k3s kubectl apply -f /tmp/vgpu_price.yaml

            mkdir -p ~/.kube
            cp /etc/rancher/k3s/k3s.yaml ~/.kube/config
            chown $(whoami):$(whoami) ~/.kube/config
            chmod 600 ~/.kube/config

            echo "[READY] K3s cluster is up and running on $(hostname)."

            while true; do
                sync
                echo 3 > /proc/sys/vm/drop_caches
                sleep 100000
            done &

            sleep infinity
          '

    serf15:
      kind: linux
      image: abdullahmuzlim279/k3s-serf-node:warmcache-test
      env:
        CLAB_LINUX_PRIVILEGED: "true"
      binds:
        - /sys/fs/cgroup:/sys/fs/cgroup:rw
        - /lib/modules:/lib/modules:ro
        - /dev:/dev
      cmd: >
          bash -c '
            set -e
            echo "[INIT] Preparing system..."
            ulimit -n 65536
            sysctl -w fs.inotify.max_user_instances=4096
            sysctl -w fs.inotify.max_user_watches=524288
            sysctl -w fs.file-max=2097152

            echo 0 > /sys/fs/cgroup/cpu.pressure || true
            echo 0 > /sys/fs/cgroup/memory.pressure || true

            echo "[NET] Waiting for eth1 to be created..."
            until ip link show eth1 >/dev/null 2>&1; do
                sleep 1
            done
            echo "[NET] eth1 detected."

            ip link set eth1 up
            #ip addr add 10.0.1.25/24 brd 10.0.1.255 dev eth1
            ip link set eth1 mtu 1400

            sleep $((RANDOM % 10 + 5))

            echo "[INIT] Launching optimized K3s server with relaxed cgroups..."
            k3s server \
              --node-name serf15 \
              --disable traefik \
              --disable servicelb \
              --disable local-storage \
              --disable metrics-server \
              --disable-cloud-controller \
              --disable-network-policy \
              --disable-helm-controller \
              --snapshotter native \
              --tls-san 10.0.2.13 \
              --kubelet-arg=cgroup-root=/ \
              --kubelet-arg=cgroups-per-qos=false \
              --kubelet-arg=enforce-node-allocatable= \
              --v=0 &

            sleep 20
            chmod 666 /etc/rancher/k3s/k3s.yaml
            export KUBECONFIG=/etc/rancher/k3s/k3s.yaml

            echo "[INIT] Waiting for containerd to be ready..."
            until /usr/local/bin/k3s ctr version >/dev/null 2>&1; do
                echo "  containerd not yet ready, retrying..."
                sleep 3
            done
            echo "Containerd is ready."

            echo "[INIT] Importing cached images..."
            for f in /opt/k3s-images/*.tar; do
                echo "Loading $f ..."
                /usr/local/bin/k3s ctr images import "$f" || true
            done

            k3s kubectl apply -f /tmp/qos-controller-daemonset.yaml
            k3s kubectl apply -f /tmp/service-account.yaml
            k3s kubectl apply -f /tmp/cluster-role.yaml
            k3s kubectl apply -f /tmp/cluster-role-binding.yaml
            k3s kubectl apply -f /tmp/deployment-scheduler.yaml
            k3s kubectl apply -f /tmp/ram_price.yaml
            k3s kubectl apply -f /tmp/storage_price.yaml
            k3s kubectl apply -f /tmp/vcpu_price.yaml
            k3s kubectl apply -f /tmp/vgpu_price.yaml

            mkdir -p ~/.kube
            cp /etc/rancher/k3s/k3s.yaml ~/.kube/config
            chown $(whoami):$(whoami) ~/.kube/config
            chmod 600 ~/.kube/config

            echo "[READY] K3s cluster is up and running on $(hostname)."

            while true; do
                sync
                echo 3 > /proc/sys/vm/drop_caches
                sleep 100000
            done &

            sleep infinity
          '

    serf16:
      kind: linux
      image: abdullahmuzlim279/k3s-serf-node:warmcache-test
      env:
        CLAB_LINUX_PRIVILEGED: "true"
      binds:
        - /sys/fs/cgroup:/sys/fs/cgroup:rw
        - /lib/modules:/lib/modules:ro
        - /dev:/dev
      cmd: >
          bash -c '
            set -e
            echo "[INIT] Preparing system..."
            ulimit -n 65536
            sysctl -w fs.inotify.max_user_instances=4096
            sysctl -w fs.inotify.max_user_watches=524288
            sysctl -w fs.file-max=2097152

            echo 0 > /sys/fs/cgroup/cpu.pressure || true
            echo 0 > /sys/fs/cgroup/memory.pressure || true

            echo "[NET] Waiting for eth1 to be created..."
            until ip link show eth1 >/dev/null 2>&1; do
                sleep 1
            done
            echo "[NET] eth1 detected."

            ip link set eth1 up
            #ip addr add 10.0.1.26/24 brd 10.0.1.255 dev eth1
            ip link set eth1 mtu 1400

            sleep $((RANDOM % 10 + 5))

            echo "[INIT] Launching optimized K3s server with relaxed cgroups..."
            k3s server \
              --node-name serf16 \
              --disable traefik \
              --disable servicelb \
              --disable local-storage \
              --disable metrics-server \
              --disable-cloud-controller \
              --disable-network-policy \
              --disable-helm-controller \
              --snapshotter native \
              --tls-san 10.0.2.14 \
              --kubelet-arg=cgroup-root=/ \
              --kubelet-arg=cgroups-per-qos=false \
              --kubelet-arg=enforce-node-allocatable= \
              --v=0 &

            sleep 20
            chmod 666 /etc/rancher/k3s/k3s.yaml
            export KUBECONFIG=/etc/rancher/k3s/k3s.yaml

            echo "[INIT] Waiting for containerd to be ready..."
            until /usr/local/bin/k3s ctr version >/dev/null 2>&1; do
                echo "  containerd not yet ready, retrying..."
                sleep 3
            done
            echo "Containerd is ready."

            echo "[INIT] Importing cached images..."
            for f in /opt/k3s-images/*.tar; do
                echo "Loading $f ..."
                /usr/local/bin/k3s ctr images import "$f" || true
            done

            k3s kubectl apply -f /tmp/qos-controller-daemonset.yaml
            k3s kubectl apply -f /tmp/service-account.yaml
            k3s kubectl apply -f /tmp/cluster-role.yaml
            k3s kubectl apply -f /tmp/cluster-role-binding.yaml
            k3s kubectl apply -f /tmp/deployment-scheduler.yaml
            k3s kubectl apply -f /tmp/ram_price.yaml
            k3s kubectl apply -f /tmp/storage_price.yaml
            k3s kubectl apply -f /tmp/vcpu_price.yaml
            k3s kubectl apply -f /tmp/vgpu_price.yaml

            mkdir -p ~/.kube
            cp /etc/rancher/k3s/k3s.yaml ~/.kube/config
            chown $(whoami):$(whoami) ~/.kube/config
            chmod 600 ~/.kube/config

            echo "[READY] K3s cluster is up and running on $(hostname)."

            while true; do
                sync
                echo 3 > /proc/sys/vm/drop_caches
                sleep 100000
            done &

            sleep infinity
          '

    serf17:
      kind: linux
      image: abdullahmuzlim279/k3s-serf-node:warmcache-test
      env:
        CLAB_LINUX_PRIVILEGED: "true"
      binds:
        - /sys/fs/cgroup:/sys/fs/cgroup:rw
        - /lib/modules:/lib/modules:ro
        - /dev:/dev
      cmd: >
          bash -c '
            set -e
            echo "[INIT] Preparing system..."
            ulimit -n 65536
            sysctl -w fs.inotify.max_user_instances=4096
            sysctl -w fs.inotify.max_user_watches=524288
            sysctl -w fs.file-max=2097152

            echo 0 > /sys/fs/cgroup/cpu.pressure || true
            echo 0 > /sys/fs/cgroup/memory.pressure || true

            echo "[NET] Waiting for eth1 to be created..."
            until ip link show eth1 >/dev/null 2>&1; do
                sleep 1
            done
            echo "[NET] eth1 detected."

            ip link set eth1 up
            #ip addr add 10.0.1.27/24 brd 10.0.1.255 dev eth1
            ip link set eth1 mtu 1400

            sleep $((RANDOM % 10 + 5))

            echo "[INIT] Launching optimized K3s server with relaxed cgroups..."
            k3s server \
              --node-name serf17 \
              --disable traefik \
              --disable servicelb \
              --disable local-storage \
              --disable metrics-server \
              --disable-cloud-controller \
              --disable-network-policy \
              --disable-helm-controller \
              --snapshotter native \
              --tls-san 10.0.2.15 \
              --kubelet-arg=cgroup-root=/ \
              --kubelet-arg=cgroups-per-qos=false \
              --kubelet-arg=enforce-node-allocatable= \
              --v=0 &

            sleep 20
            chmod 666 /etc/rancher/k3s/k3s.yaml
            export KUBECONFIG=/etc/rancher/k3s/k3s.yaml

            echo "[INIT] Waiting for containerd to be ready..."
            until /usr/local/bin/k3s ctr version >/dev/null 2>&1; do
                echo "  containerd not yet ready, retrying..."
                sleep 3
            done
            echo "Containerd is ready."

            echo "[INIT] Importing cached images..."
            for f in /opt/k3s-images/*.tar; do
                echo "Loading $f ..."
                /usr/local/bin/k3s ctr images import "$f" || true
            done

            k3s kubectl apply -f /tmp/qos-controller-daemonset.yaml
            k3s kubectl apply -f /tmp/service-account.yaml
            k3s kubectl apply -f /tmp/cluster-role.yaml
            k3s kubectl apply -f /tmp/cluster-role-binding.yaml
            k3s kubectl apply -f /tmp/deployment-scheduler.yaml
            k3s kubectl apply -f /tmp/ram_price.yaml
            k3s kubectl apply -f /tmp/storage_price.yaml
            k3s kubectl apply -f /tmp/vcpu_price.yaml
            k3s kubectl apply -f /tmp/vgpu_price.yaml

            mkdir -p ~/.kube
            cp /etc/rancher/k3s/k3s.yaml ~/.kube/config
            chown $(whoami):$(whoami) ~/.kube/config
            chmod 600 ~/.kube/config

            echo "[READY] K3s cluster is up and running on $(hostname)."

            while true; do
                sync
                echo 3 > /proc/sys/vm/drop_caches
                sleep 100000
            done &

            sleep infinity
          '

    serf18:
      kind: linux
      image: abdullahmuzlim279/k3s-serf-node:warmcache-test
      env:
        CLAB_LINUX_PRIVILEGED: "true"
      binds:
        - /sys/fs/cgroup:/sys/fs/cgroup:rw
        - /lib/modules:/lib/modules:ro
        - /dev:/dev
      cmd: >
          bash -c '
            set -e
            echo "[INIT] Preparing system..."
            ulimit -n 65536
            sysctl -w fs.inotify.max_user_instances=4096
            sysctl -w fs.inotify.max_user_watches=524288
            sysctl -w fs.file-max=2097152

            echo 0 > /sys/fs/cgroup/cpu.pressure || true
            echo 0 > /sys/fs/cgroup/memory.pressure || true

            echo "[NET] Waiting for eth1 to be created..."
            until ip link show eth1 >/dev/null 2>&1; do
                sleep 1
            done
            echo "[NET] eth1 detected."

            ip link set eth1 up
            #ip addr add 10.0.1.28/24 brd 10.0.1.255 dev eth1
            ip link set eth1 mtu 1400

            sleep $((RANDOM % 10 + 5))

            echo "[INIT] Launching optimized K3s server with relaxed cgroups..."
            k3s server \
              --node-name serf18 \
              --disable traefik \
              --disable servicelb \
              --disable local-storage \
              --disable metrics-server \
              --disable-cloud-controller \
              --disable-network-policy \
              --disable-helm-controller \
              --snapshotter native \
              --tls-san 10.0.2.16 \
              --kubelet-arg=cgroup-root=/ \
              --kubelet-arg=cgroups-per-qos=false \
              --kubelet-arg=enforce-node-allocatable= \
              --v=0 &

            sleep 20
            chmod 666 /etc/rancher/k3s/k3s.yaml
            export KUBECONFIG=/etc/rancher/k3s/k3s.yaml

            echo "[INIT] Waiting for containerd to be ready..."
            until /usr/local/bin/k3s ctr version >/dev/null 2>&1; do
                echo "  containerd not yet ready, retrying..."
                sleep 3
            done
            echo "Containerd is ready."

            echo "[INIT] Importing cached images..."
            for f in /opt/k3s-images/*.tar; do
                echo "Loading $f ..."
                /usr/local/bin/k3s ctr images import "$f" || true
            done

            k3s kubectl apply -f /tmp/qos-controller-daemonset.yaml
            k3s kubectl apply -f /tmp/service-account.yaml
            k3s kubectl apply -f /tmp/cluster-role.yaml
            k3s kubectl apply -f /tmp/cluster-role-binding.yaml
            k3s kubectl apply -f /tmp/deployment-scheduler.yaml
            k3s kubectl apply -f /tmp/ram_price.yaml
            k3s kubectl apply -f /tmp/storage_price.yaml
            k3s kubectl apply -f /tmp/vcpu_price.yaml
            k3s kubectl apply -f /tmp/vgpu_price.yaml

            mkdir -p ~/.kube
            cp /etc/rancher/k3s/k3s.yaml ~/.kube/config
            chown $(whoami):$(whoami) ~/.kube/config
            chmod 600 ~/.kube/config

            echo "[READY] K3s cluster is up and running on $(hostname)."

            while true; do
                sync
                echo 3 > /proc/sys/vm/drop_caches
                sleep 100000
            done &

            sleep infinity
          '

    serf19:
      kind: linux
      image: abdullahmuzlim279/k3s-serf-node:warmcache-test
      env:
        CLAB_LINUX_PRIVILEGED: "true"
      binds:
        - /sys/fs/cgroup:/sys/fs/cgroup:rw
        - /lib/modules:/lib/modules:ro
        - /dev:/dev
      cmd: >
          bash -c '
            set -e
            echo "[INIT] Preparing system..."
            ulimit -n 65536
            sysctl -w fs.inotify.max_user_instances=4096
            sysctl -w fs.inotify.max_user_watches=524288
            sysctl -w fs.file-max=2097152

            echo 0 > /sys/fs/cgroup/cpu.pressure || true
            echo 0 > /sys/fs/cgroup/memory.pressure || true

            echo "[NET] Waiting for eth1 to be created..."
            until ip link show eth1 >/dev/null 2>&1; do
                sleep 1
            done
            echo "[NET] eth1 detected."

            ip link set eth1 up
            #ip addr add 10.0.1.29/24 brd 10.0.1.255 dev eth1
            ip link set eth1 mtu 1400

            sleep $((RANDOM % 10 + 5))

            echo "[INIT] Launching optimized K3s server with relaxed cgroups..."
            k3s server \
              --node-name serf19 \
              --disable traefik \
              --disable servicelb \
              --disable local-storage \
              --disable metrics-server \
              --disable-cloud-controller \
              --disable-network-policy \
              --disable-helm-controller \
              --snapshotter native \
              --tls-san 10.0.2.17 \
              --kubelet-arg=cgroup-root=/ \
              --kubelet-arg=cgroups-per-qos=false \
              --kubelet-arg=enforce-node-allocatable= \
              --v=0 &

            sleep 20
            chmod 666 /etc/rancher/k3s/k3s.yaml
            export KUBECONFIG=/etc/rancher/k3s/k3s.yaml

            echo "[INIT] Waiting for containerd to be ready..."
            until /usr/local/bin/k3s ctr version >/dev/null 2>&1; do
                echo "  containerd not yet ready, retrying..."
                sleep 3
            done
            echo "Containerd is ready."

            echo "[INIT] Importing cached images..."
            for f in /opt/k3s-images/*.tar; do
                echo "Loading $f ..."
                /usr/local/bin/k3s ctr images import "$f" || true
            done

            k3s kubectl apply -f /tmp/qos-controller-daemonset.yaml
            k3s kubectl apply -f /tmp/service-account.yaml
            k3s kubectl apply -f /tmp/cluster-role.yaml
            k3s kubectl apply -f /tmp/cluster-role-binding.yaml
            k3s kubectl apply -f /tmp/deployment-scheduler.yaml
            k3s kubectl apply -f /tmp/ram_price.yaml
            k3s kubectl apply -f /tmp/storage_price.yaml
            k3s kubectl apply -f /tmp/vcpu_price.yaml
            k3s kubectl apply -f /tmp/vgpu_price.yaml

            mkdir -p ~/.kube
            cp /etc/rancher/k3s/k3s.yaml ~/.kube/config
            chown $(whoami):$(whoami) ~/.kube/config
            chmod 600 ~/.kube/config

            echo "[READY] K3s cluster is up and running on $(hostname)."

            while true; do
                sync
                echo 3 > /proc/sys/vm/drop_caches
                sleep 100000
            done &

            sleep infinity
          '

    serf20:
      kind: linux
      image: abdullahmuzlim279/k3s-serf-node:warmcache-test
      env:
        CLAB_LINUX_PRIVILEGED: "true"
      binds:
        - /sys/fs/cgroup:/sys/fs/cgroup:rw
        - /lib/modules:/lib/modules:ro
        - /dev:/dev
      cmd: >
          bash -c '
            set -e
            echo "[INIT] Preparing system..."
            ulimit -n 65536
            sysctl -w fs.inotify.max_user_instances=4096
            sysctl -w fs.inotify.max_user_watches=524288
            sysctl -w fs.file-max=2097152

            echo 0 > /sys/fs/cgroup/cpu.pressure || true
            echo 0 > /sys/fs/cgroup/memory.pressure || true

            echo "[NET] Waiting for eth1 to be created..."
            until ip link show eth1 >/dev/null 2>&1; do
                sleep 1
            done
            echo "[NET] eth1 detected."

            ip link set eth1 up
            #ip addr add 10.0.1.30/24 brd 10.0.1.255 dev eth1
            ip link set eth1 mtu 1400

            sleep $((RANDOM % 10 + 5))

            echo "[INIT] Launching optimized K3s server with relaxed cgroups..."
            k3s server \
              --node-name serf20 \
              --disable traefik \
              --disable servicelb \
              --disable local-storage \
              --disable metrics-server \
              --disable-cloud-controller \
              --disable-network-policy \
              --disable-helm-controller \
              --snapshotter native \
              --tls-san 10.0.2.18 \
              --kubelet-arg=cgroup-root=/ \
              --kubelet-arg=cgroups-per-qos=false \
              --kubelet-arg=enforce-node-allocatable= \
              --v=0 &

            sleep 20
            chmod 666 /etc/rancher/k3s/k3s.yaml
            export KUBECONFIG=/etc/rancher/k3s/k3s.yaml

            echo "[INIT] Waiting for containerd to be ready..."
            until /usr/local/bin/k3s ctr version >/dev/null 2>&1; do
                echo "  containerd not yet ready, retrying..."
                sleep 3
            done
            echo "Containerd is ready."

            echo "[INIT] Importing cached images..."
            for f in /opt/k3s-images/*.tar; do
                echo "Loading $f ..."
                /usr/local/bin/k3s ctr images import "$f" || true
            done

            k3s kubectl apply -f /tmp/qos-controller-daemonset.yaml
            k3s kubectl apply -f /tmp/service-account.yaml
            k3s kubectl apply -f /tmp/cluster-role.yaml
            k3s kubectl apply -f /tmp/cluster-role-binding.yaml
            k3s kubectl apply -f /tmp/deployment-scheduler.yaml
            k3s kubectl apply -f /tmp/ram_price.yaml
            k3s kubectl apply -f /tmp/storage_price.yaml
            k3s kubectl apply -f /tmp/vcpu_price.yaml
            k3s kubectl apply -f /tmp/vgpu_price.yaml

            mkdir -p ~/.kube
            cp /etc/rancher/k3s/k3s.yaml ~/.kube/config
            chown $(whoami):$(whoami) ~/.kube/config
            chmod 600 ~/.kube/config

            echo "[READY] K3s cluster is up and running on $(hostname)."

            while true; do
                sync
                echo 3 > /proc/sys/vm/drop_caches
                sleep 100000
            done &

            sleep infinity
          '

    serf21:
      kind: linux
      image: abdullahmuzlim279/k3s-serf-node:warmcache-test
      env:
        CLAB_LINUX_PRIVILEGED: "true"
      binds:
        - /sys/fs/cgroup:/sys/fs/cgroup:rw
        - /lib/modules:/lib/modules:ro
        - /dev:/dev
      cmd: >
          bash -c '
            set -e
            echo "[INIT] Preparing system..."
            ulimit -n 65536
            sysctl -w fs.inotify.max_user_instances=4096
            sysctl -w fs.inotify.max_user_watches=524288
            sysctl -w fs.file-max=2097152

            echo 0 > /sys/fs/cgroup/cpu.pressure || true
            echo 0 > /sys/fs/cgroup/memory.pressure || true

            echo "[NET] Waiting for eth1 to be created..."
            until ip link show eth1 >/dev/null 2>&1; do
                sleep 1
            done
            echo "[NET] eth1 detected."

            ip link set eth1 up
            #ip addr add 10.0.1.31/24 brd 10.0.1.255 dev eth1
            ip link set eth1 mtu 1400

            sleep $((RANDOM % 10 + 5))

            echo "[INIT] Launching optimized K3s server with relaxed cgroups..."
            k3s server \
              --node-name serf21 \
              --disable traefik \
              --disable servicelb \
              --disable local-storage \
              --disable metrics-server \
              --disable-cloud-controller \
              --disable-network-policy \
              --disable-helm-controller \
              --snapshotter native \
              --tls-san 10.0.2.19 \
              --kubelet-arg=cgroup-root=/ \
              --kubelet-arg=cgroups-per-qos=false \
              --kubelet-arg=enforce-node-allocatable= \
              --v=0 &

            sleep 20
            chmod 666 /etc/rancher/k3s/k3s.yaml
            export KUBECONFIG=/etc/rancher/k3s/k3s.yaml

            echo "[INIT] Waiting for containerd to be ready..."
            until /usr/local/bin/k3s ctr version >/dev/null 2>&1; do
                echo "  containerd not yet ready, retrying..."
                sleep 3
            done
            echo "Containerd is ready."

            echo "[INIT] Importing cached images..."
            for f in /opt/k3s-images/*.tar; do
                echo "Loading $f ..."
                /usr/local/bin/k3s ctr images import "$f" || true
            done

            k3s kubectl apply -f /tmp/qos-controller-daemonset.yaml
            k3s kubectl apply -f /tmp/service-account.yaml
            k3s kubectl apply -f /tmp/cluster-role.yaml
            k3s kubectl apply -f /tmp/cluster-role-binding.yaml
            k3s kubectl apply -f /tmp/deployment-scheduler.yaml
            k3s kubectl apply -f /tmp/ram_price.yaml
            k3s kubectl apply -f /tmp/storage_price.yaml
            k3s kubectl apply -f /tmp/vcpu_price.yaml
            k3s kubectl apply -f /tmp/vgpu_price.yaml

            mkdir -p ~/.kube
            cp /etc/rancher/k3s/k3s.yaml ~/.kube/config
            chown $(whoami):$(whoami) ~/.kube/config
            chmod 600 ~/.kube/config

            echo "[READY] K3s cluster is up and running on $(hostname)."

            while true; do
                sync
                echo 3 > /proc/sys/vm/drop_caches
                sleep 100000
            done &

            sleep infinity
          '

    serf22:
      kind: linux
      image: abdullahmuzlim279/k3s-serf-node:warmcache-test
      env:
        CLAB_LINUX_PRIVILEGED: "true"
      binds:
        - /sys/fs/cgroup:/sys/fs/cgroup:rw
        - /lib/modules:/lib/modules:ro
        - /dev:/dev
      cmd: >
          bash -c '
            set -e
            echo "[INIT] Preparing system..."
            ulimit -n 65536
            sysctl -w fs.inotify.max_user_instances=4096
            sysctl -w fs.inotify.max_user_watches=524288
            sysctl -w fs.file-max=2097152

            echo 0 > /sys/fs/cgroup/cpu.pressure || true
            echo 0 > /sys/fs/cgroup/memory.pressure || true

            echo "[NET] Waiting for eth1 to be created..."
            until ip link show eth1 >/dev/null 2>&1; do
                sleep 1
            done
            echo "[NET] eth1 detected."

            ip link set eth1 up
            #ip addr add 10.0.1.32/24 brd 10.0.1.255 dev eth1
            ip link set eth1 mtu 1400

            sleep $((RANDOM % 10 + 5))

            echo "[INIT] Launching optimized K3s server with relaxed cgroups..."
            k3s server \
              --node-name serf22 \
              --disable traefik \
              --disable servicelb \
              --disable local-storage \
              --disable metrics-server \
              --disable-cloud-controller \
              --disable-network-policy \
              --disable-helm-controller \
              --snapshotter native \
              --tls-san 10.0.2.20 \
              --kubelet-arg=cgroup-root=/ \
              --kubelet-arg=cgroups-per-qos=false \
              --kubelet-arg=enforce-node-allocatable= \
              --v=0 &

            sleep 20
            chmod 666 /etc/rancher/k3s/k3s.yaml
            export KUBECONFIG=/etc/rancher/k3s/k3s.yaml

            echo "[INIT] Waiting for containerd to be ready..."
            until /usr/local/bin/k3s ctr version >/dev/null 2>&1; do
                echo "  containerd not yet ready, retrying..."
                sleep 3
            done
            echo "Containerd is ready."

            echo "[INIT] Importing cached images..."
            for f in /opt/k3s-images/*.tar; do
                echo "Loading $f ..."
                /usr/local/bin/k3s ctr images import "$f" || true
            done

            k3s kubectl apply -f /tmp/qos-controller-daemonset.yaml
            k3s kubectl apply -f /tmp/service-account.yaml
            k3s kubectl apply -f /tmp/cluster-role.yaml
            k3s kubectl apply -f /tmp/cluster-role-binding.yaml
            k3s kubectl apply -f /tmp/deployment-scheduler.yaml
            k3s kubectl apply -f /tmp/ram_price.yaml
            k3s kubectl apply -f /tmp/storage_price.yaml
            k3s kubectl apply -f /tmp/vcpu_price.yaml
            k3s kubectl apply -f /tmp/vgpu_price.yaml

            mkdir -p ~/.kube
            cp /etc/rancher/k3s/k3s.yaml ~/.kube/config
            chown $(whoami):$(whoami) ~/.kube/config
            chmod 600 ~/.kube/config

            echo "[READY] K3s cluster is up and running on $(hostname)."

            while true; do
                sync
                echo 3 > /proc/sys/vm/drop_caches
                sleep 100000
            done &

            sleep infinity
          '

    serf23:
      kind: linux
      image: abdullahmuzlim279/k3s-serf-node:warmcache-test
      env:
        CLAB_LINUX_PRIVILEGED: "true"
      binds:
        - /sys/fs/cgroup:/sys/fs/cgroup:rw
        - /lib/modules:/lib/modules:ro
        - /dev:/dev
      cmd: >
          bash -c '
            set -e
            echo "[INIT] Preparing system..."
            ulimit -n 65536
            sysctl -w fs.inotify.max_user_instances=4096
            sysctl -w fs.inotify.max_user_watches=524288
            sysctl -w fs.file-max=2097152

            echo 0 > /sys/fs/cgroup/cpu.pressure || true
            echo 0 > /sys/fs/cgroup/memory.pressure || true

            echo "[NET] Waiting for eth1 to be created..."
            until ip link show eth1 >/dev/null 2>&1; do
                sleep 1
            done
            echo "[NET] eth1 detected."

            ip link set eth1 up
            #ip addr add 10.0.1.33/24 brd 10.0.1.255 dev eth1
            ip link set eth1 mtu 1400

            sleep $((RANDOM % 10 + 5))

            echo "[INIT] Launching optimized K3s server with relaxed cgroups..."
            k3s server \
              --node-name serf23 \
              --disable traefik \
              --disable servicelb \
              --disable local-storage \
              --disable metrics-server \
              --disable-cloud-controller \
              --disable-network-policy \
              --disable-helm-controller \
              --snapshotter native \
              --tls-san 10.0.2.21 \
              --kubelet-arg=cgroup-root=/ \
              --kubelet-arg=cgroups-per-qos=false \
              --kubelet-arg=enforce-node-allocatable= \
              --v=0 &

            sleep 20
            chmod 666 /etc/rancher/k3s/k3s.yaml
            export KUBECONFIG=/etc/rancher/k3s/k3s.yaml

            echo "[INIT] Waiting for containerd to be ready..."
            until /usr/local/bin/k3s ctr version >/dev/null 2>&1; do
                echo "  containerd not yet ready, retrying..."
                sleep 3
            done
            echo "Containerd is ready."

            echo "[INIT] Importing cached images..."
            for f in /opt/k3s-images/*.tar; do
                echo "Loading $f ..."
                /usr/local/bin/k3s ctr images import "$f" || true
            done

            k3s kubectl apply -f /tmp/qos-controller-daemonset.yaml
            k3s kubectl apply -f /tmp/service-account.yaml
            k3s kubectl apply -f /tmp/cluster-role.yaml
            k3s kubectl apply -f /tmp/cluster-role-binding.yaml
            k3s kubectl apply -f /tmp/deployment-scheduler.yaml
            k3s kubectl apply -f /tmp/ram_price.yaml
            k3s kubectl apply -f /tmp/storage_price.yaml
            k3s kubectl apply -f /tmp/vcpu_price.yaml
            k3s kubectl apply -f /tmp/vgpu_price.yaml

            mkdir -p ~/.kube
            cp /etc/rancher/k3s/k3s.yaml ~/.kube/config
            chown $(whoami):$(whoami) ~/.kube/config
            chmod 600 ~/.kube/config

            echo "[READY] K3s cluster is up and running on $(hostname)."

            while true; do
                sync
                echo 3 > /proc/sys/vm/drop_caches
                sleep 100000
            done &

            sleep infinity
          '

    serf24:
      kind: linux
      image: abdullahmuzlim279/k3s-serf-node:warmcache-test
      env:
        CLAB_LINUX_PRIVILEGED: "true"
      binds:
        - /sys/fs/cgroup:/sys/fs/cgroup:rw
        - /lib/modules:/lib/modules:ro
        - /dev:/dev
      cmd: >
          bash -c '
            set -e
            echo "[INIT] Preparing system..."
            ulimit -n 65536
            sysctl -w fs.inotify.max_user_instances=4096
            sysctl -w fs.inotify.max_user_watches=524288
            sysctl -w fs.file-max=2097152

            echo 0 > /sys/fs/cgroup/cpu.pressure || true
            echo 0 > /sys/fs/cgroup/memory.pressure || true

            echo "[NET] Waiting for eth1 to be created..."
            until ip link show eth1 >/dev/null 2>&1; do
                sleep 1
            done
            echo "[NET] eth1 detected."

            ip link set eth1 up
            #ip addr add 10.0.1.34/24 brd 10.0.1.255 dev eth1
            ip link set eth1 mtu 1400

            sleep $((RANDOM % 10 + 5))

            echo "[INIT] Launching optimized K3s server with relaxed cgroups..."
            k3s server \
              --node-name serf24 \
              --disable traefik \
              --disable servicelb \
              --disable local-storage \
              --disable metrics-server \
              --disable-cloud-controller \
              --disable-network-policy \
              --disable-helm-controller \
              --snapshotter native \
              --tls-san 10.0.2.22 \
              --kubelet-arg=cgroup-root=/ \
              --kubelet-arg=cgroups-per-qos=false \
              --kubelet-arg=enforce-node-allocatable= \
              --v=0 &

            sleep 20
            chmod 666 /etc/rancher/k3s/k3s.yaml
            export KUBECONFIG=/etc/rancher/k3s/k3s.yaml

            echo "[INIT] Waiting for containerd to be ready..."
            until /usr/local/bin/k3s ctr version >/dev/null 2>&1; do
                echo "  containerd not yet ready, retrying..."
                sleep 3
            done
            echo "Containerd is ready."

            echo "[INIT] Importing cached images..."
            for f in /opt/k3s-images/*.tar; do
                echo "Loading $f ..."
                /usr/local/bin/k3s ctr images import "$f" || true
            done

            k3s kubectl apply -f /tmp/qos-controller-daemonset.yaml
            k3s kubectl apply -f /tmp/service-account.yaml
            k3s kubectl apply -f /tmp/cluster-role.yaml
            k3s kubectl apply -f /tmp/cluster-role-binding.yaml
            k3s kubectl apply -f /tmp/deployment-scheduler.yaml
            k3s kubectl apply -f /tmp/ram_price.yaml
            k3s kubectl apply -f /tmp/storage_price.yaml
            k3s kubectl apply -f /tmp/vcpu_price.yaml
            k3s kubectl apply -f /tmp/vgpu_price.yaml

            mkdir -p ~/.kube
            cp /etc/rancher/k3s/k3s.yaml ~/.kube/config
            chown $(whoami):$(whoami) ~/.kube/config
            chmod 600 ~/.kube/config

            echo "[READY] K3s cluster is up and running on $(hostname)."

            while true; do
                sync
                echo 3 > /proc/sys/vm/drop_caches
                sleep 100000
            done &

            sleep infinity
          '

    serf25:
      kind: linux
      image: abdullahmuzlim279/k3s-serf-node:warmcache-test
      env:
        CLAB_LINUX_PRIVILEGED: "true"
      binds:
        - /sys/fs/cgroup:/sys/fs/cgroup:rw
        - /lib/modules:/lib/modules:ro
        - /dev:/dev
      cmd: >
          bash -c '
            set -e
            echo "[INIT] Preparing system..."
            ulimit -n 65536
            sysctl -w fs.inotify.max_user_instances=4096
            sysctl -w fs.inotify.max_user_watches=524288
            sysctl -w fs.file-max=2097152

            echo 0 > /sys/fs/cgroup/cpu.pressure || true
            echo 0 > /sys/fs/cgroup/memory.pressure || true

            echo "[NET] Waiting for eth1 to be created..."
            until ip link show eth1 >/dev/null 2>&1; do
                sleep 1
            done
            echo "[NET] eth1 detected."

            ip link set eth1 up
            #ip addr add 10.0.1.35/24 brd 10.0.1.255 dev eth1
            ip link set eth1 mtu 1400

            sleep $((RANDOM % 10 + 5))

            echo "[INIT] Launching optimized K3s server with relaxed cgroups..."
            k3s server \
              --node-name serf25 \
              --disable traefik \
              --disable servicelb \
              --disable local-storage \
              --disable metrics-server \
              --disable-cloud-controller \
              --disable-network-policy \
              --disable-helm-controller \
              --snapshotter native \
              --tls-san 10.0.2.23 \
              --kubelet-arg=cgroup-root=/ \
              --kubelet-arg=cgroups-per-qos=false \
              --kubelet-arg=enforce-node-allocatable= \
              --v=0 &

            sleep 20
            chmod 666 /etc/rancher/k3s/k3s.yaml
            export KUBECONFIG=/etc/rancher/k3s/k3s.yaml

            echo "[INIT] Waiting for containerd to be ready..."
            until /usr/local/bin/k3s ctr version >/dev/null 2>&1; do
                echo "  containerd not yet ready, retrying..."
                sleep 3
            done
            echo "Containerd is ready."

            echo "[INIT] Importing cached images..."
            for f in /opt/k3s-images/*.tar; do
                echo "Loading $f ..."
                /usr/local/bin/k3s ctr images import "$f" || true
            done

            k3s kubectl apply -f /tmp/qos-controller-daemonset.yaml
            k3s kubectl apply -f /tmp/service-account.yaml
            k3s kubectl apply -f /tmp/cluster-role.yaml
            k3s kubectl apply -f /tmp/cluster-role-binding.yaml
            k3s kubectl apply -f /tmp/deployment-scheduler.yaml
            k3s kubectl apply -f /tmp/ram_price.yaml
            k3s kubectl apply -f /tmp/storage_price.yaml
            k3s kubectl apply -f /tmp/vcpu_price.yaml
            k3s kubectl apply -f /tmp/vgpu_price.yaml

            mkdir -p ~/.kube
            cp /etc/rancher/k3s/k3s.yaml ~/.kube/config
            chown $(whoami):$(whoami) ~/.kube/config
            chmod 600 ~/.kube/config

            echo "[READY] K3s cluster is up and running on $(hostname)."

            while true; do
                sync
                echo 3 > /proc/sys/vm/drop_caches
                sleep 100000
            done &

            sleep infinity
          '

  links:
    # Router uplinks to both switches
    - endpoints: ["switch_a:eth20", "rtr:eth1"]
    - endpoints: ["switch_b:eth27", "rtr:eth2"]

    # -------- serf1..serf12 on switch_a --------
    - endpoints: ["switch_a:eth14",  "serf1:eth1"]
    - endpoints: ["switch_a:eth22",  "serf2:eth1"]
    - endpoints: ["switch_a:eth33",  "serf3:eth1"]
    - endpoints: ["switch_a:eth44",  "serf4:eth1"]
    - endpoints: ["switch_a:eth55",  "serf5:eth1"]
    - endpoints: ["switch_a:eth66",  "serf6:eth1"]
    - endpoints: ["switch_a:eth77",  "serf7:eth1"]
    - endpoints: ["switch_a:eth85",  "serf8:eth1"]
    - endpoints: ["switch_a:eth92",  "serf9:eth1"]
    - endpoints: ["switch_a:eth10", "serf10:eth1"]
    - endpoints: ["switch_a:eth16", "serf11:eth1"]
    - endpoints: ["switch_a:eth12", "serf12:eth1"]

    # -------- serf13..serf25 on switch_b --------
    - endpoints: ["switch_b:eth15",  "serf13:eth1"]
    - endpoints: ["switch_b:eth21",  "serf14:eth1"]
    - endpoints: ["switch_b:eth32",  "serf15:eth1"]
    - endpoints: ["switch_b:eth43",  "serf16:eth1"]
    - endpoints: ["switch_b:eth54",  "serf17:eth1"]
    - endpoints: ["switch_b:eth65",  "serf18:eth1"]
    - endpoints: ["switch_b:eth76",  "serf19:eth1"]
    - endpoints: ["switch_b:eth87",  "serf20:eth1"]
    - endpoints: ["switch_b:eth98",  "serf21:eth1"]
    - endpoints: ["switch_b:eth13", "serf22:eth1"]
    - endpoints: ["switch_b:eth11", "serf23:eth1"]
    - endpoints: ["switch_b:eth18", "serf24:eth1"]
    - endpoints: ["switch_b:eth17", "serf25:eth1"]
